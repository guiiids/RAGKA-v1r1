<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAGKA Analytics Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jQuery (required for daterangepicker) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- ApexCharts for advanced visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <!-- Date Range Picker -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .dashboard-card {
            transition: all 0.3s ease;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .data-table {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <img class="h-8 w-auto" src="https://content.tst-34.aws.agilent.com/wp-content/uploads/2025/05/logo-spark-1.png" alt="RAGKA Logo">
                        <span class="ml-2 text-xl font-bold text-gray-800">RAGKA Analytics</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="relative">
                        <button id="date-range-btn" class="flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none">
                            <i class="fas fa-calendar-alt mr-2"></i>
                            <span id="date-range-text">Last 7 days</span>
                            <i class="fas fa-chevron-down ml-2"></i>
                        </button>
                    </div>
                    <button class="ml-4 px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none">
                        <i class="fas fa-download mr-2"></i>
                        Export Data
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Overview Section -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Overview</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Total Interactions Card -->
                <div class="dashboard-card bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                            <i class="fas fa-comments text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Total Interactions</p>
                            <p class="text-2xl font-semibold text-gray-800" id="total-interactions"></p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="flex items-center">
                            <span class="text-green-500 text-sm font-medium flex items-center">
                                <i class="fas fa-arrow-up mr-1"></i>
                                12.5%
                            </span>
                            <span class="text-gray-500 text-sm ml-2">vs last period</span>
                        </div>
                    </div>
                </div>

                <!-- Positive Feedback Card -->
                <div class="dashboard-card bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100 text-green-600">
                            <i class="fas fa-thumbs-up text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Positive Feedback</p>
                            <p class="text-2xl font-semibold text-gray-800" id="positive-feedback"></p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="flex items-center">
                            <span class="text-green-500 text-sm font-medium flex items-center">
                                <i class="fas fa-arrow-up mr-1"></i>
                                3.2%
                            </span>
                            <span class="text-gray-500 text-sm ml-2">vs last period</span>
                        </div>
                    </div>
                </div>

                <!-- Average Response Time Card -->
                <div class="dashboard-card bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                            <i class="fas fa-clock text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Avg Response Time</p>
                            <p class="text-2xl font-semibold text-gray-800" id="avg-response-time"></p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="flex items-center">
                            <span class="text-green-500 text-sm font-medium flex items-center">
                                <i class="fas fa-arrow-down mr-1"></i>
                                0.3s
                            </span>
                            <span class="text-gray-500 text-sm ml-2">vs last period</span>
                        </div>
                    </div>
                </div>

                <!-- Token Usage Card -->
                <div class="dashboard-card bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                            <i class="fas fa-bolt text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Token Usage</p>
                            <p class="text-2xl font-semibold text-gray-800" id="token-usage"></p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="flex items-center">
                            <span class="text-red-500 text-sm font-medium flex items-center">
                                <i class="fas fa-arrow-up mr-1"></i>
                                8.1%
                            </span>
                            <span class="text-gray-500 text-sm ml-2">vs last period</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Interactions Over Time Chart -->
            <div class="dashboard-card bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Interactions Over Time</h3>
                <div class="chart-container">
                    <canvas id="interactions-chart"></canvas>
                </div>
            </div>

            <!-- Feedback Distribution Chart -->
            <div class="dashboard-card bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Feedback Distribution</h3>
                <div class="chart-container">
                    <canvas id="feedback-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- More Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <!-- Top Query Categories -->
            <div class="dashboard-card bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Top Query Categories</h3>
                <div class="chart-container" style="height: 250px;">
                    <canvas id="categories-chart"></canvas>
                </div>
            </div>

            <!-- Response Time Distribution -->
            <div class="dashboard-card bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Response Time Distribution</h3>
                <div class="chart-container" style="height: 250px;">
                    <canvas id="response-time-chart"></canvas>
                </div>
            </div>

            <!-- Token Usage by Day -->
            <div class="dashboard-card bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Token Usage by Day</h3>
                <div class="chart-container" style="height: 250px;">
                    <canvas id="token-usage-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Recent Interactions Table -->
        <div class="dashboard-card bg-white rounded-lg shadow mb-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800">Recent Interactions</h3>
            </div>
            <div class="data-table">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Query</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Feedback</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Response Time</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tokens</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="recent-interactions-table">
                        <!-- Table rows will be populated dynamically -->
                    </tbody>
                </table>
            </div>
            <div class="px-6 py-4 border-t border-gray-200 flex items-center justify-between">
                <div class="flex items-center">
                    <span class="text-sm text-gray-700">
                        Showing <span class="font-medium">1</span> to <span class="font-medium">10</span> of <span class="font-medium">97</span> results
                    </span>
                </div>
                <div class="flex items-center space-x-2">
                    <button class="px-3 py-1 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                        Previous
                    </button>
                    <button class="px-3 py-1 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                        Next
                    </button>
                </div>
            </div>
        </div>

        <!-- Feedback Analysis Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Feedback Tags Distribution -->
            <div class="dashboard-card bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Feedback Tags Distribution</h3>
                <div class="chart-container">
                    <canvas id="feedback-tags-chart"></canvas>
                </div>
            </div>

            <!-- Common Issues Word Cloud -->
            <div class="dashboard-card bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Common Issues</h3>
                <div id="issues-word-cloud" style="height: 300px;"></div>
            </div>
        </div>

        <!-- Model Performance Section -->
        <div class="dashboard-card bg-white rounded-lg shadow p-6 mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Model Performance Metrics</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Accuracy Card -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <p class="text-sm font-medium text-gray-500">Accuracy</p>
                        <div class="p-2 rounded-full bg-blue-100 text-blue-600">
                            <i class="fas fa-bullseye text-sm"></i>
                        </div>
                    </div>
                    <p class="text-2xl font-semibold text-gray-800 mt-2"></p>
                    <div class="mt-2">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full" style="width: 92.7%"></div>
                        </div>
                    </div>
                </div>

                <!-- Relevance Card -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <p class="text-sm font-medium text-gray-500">Relevance</p>
                        <div class="p-2 rounded-full bg-green-100 text-green-600">
                            <i class="fas fa-check-circle text-sm"></i>
                        </div>
                    </div>
                    <p class="text-2xl font-semibold text-gray-800 mt-2"></p>
                    <div class="mt-2">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-green-600 h-2 rounded-full" style="width: 88.3%"></div>
                        </div>
                    </div>
                </div>

                <!-- Coherence Card -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <p class="text-sm font-medium text-gray-500">Coherence</p>
                        <div class="p-2 rounded-full bg-purple-100 text-purple-600">
                            <i class="fas fa-link text-sm"></i>
                        </div>
                    </div>
                    <p class="text-2xl font-semibold text-gray-800 mt-2"></p>
                    <div class="mt-2">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-purple-600 h-2 rounded-full" style="width: 94.1%"></div>
                        </div>
                    </div>
                </div>

                <!-- Hallucination Rate Card -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <p class="text-sm font-medium text-gray-500">Hallucination Rate</p>
                        <div class="p-2 rounded-full bg-red-100 text-red-600">
                            <i class="fas fa-exclamation-triangle text-sm"></i>
                        </div>
                    </div>
                    <p class="text-2xl font-semibold text-gray-800 mt-2"></p>
                    <div class="mt-2">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-red-600 h-2 rounded-full" style="width: 3.2%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 py-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500">© 2025 RAGKA Analytics Dashboard. All rights reserved.</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Last updated: <span id="last-updated">June 18, 2025 5:03 PM</span></p>
                </div>
            </div>
        </div>
    </footer>

    <!-- JavaScript for Charts and Data -->
    <script>
        // Global variables for chart instances
        window.chartInstances = {};
        window.currentStartDate = null;
        window.currentEndDate = null;

        // Initialize dashboard when the DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Show loading indicators
            showLoadingState();
            
            // Fetch analytics data from API
            fetchAnalyticsData();
            
            // Initialize Date Range Picker
            initDateRangePicker();
            
            // Add event listener to export button
            setupExportButton();
            
            // Setup export links
            setupExportLinks();
            
            // Initialize word cloud placeholder
            initWordCloud();
            
            // Setup date range presets after a short delay to ensure date range picker is initialized
            setTimeout(setupDateRangePresets, 500);
        });

        // Function to show loading state
        function showLoadingState() {
            // Add loading overlay to each card
            document.querySelectorAll('.dashboard-card').forEach(card => {
                const loadingOverlay = document.createElement('div');
                loadingOverlay.className = 'absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center loading-overlay';
                loadingOverlay.innerHTML = `
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                `;
                card.style.position = 'relative';
                card.appendChild(loadingOverlay);
            });
            
            // Add loading overlay to the table
            const tableContainer = document.querySelector('.data-table');
            if (tableContainer) {
                const loadingOverlay = document.createElement('div');
                loadingOverlay.className = 'absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center loading-overlay';
                loadingOverlay.innerHTML = `
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                `;
                tableContainer.style.position = 'relative';
                tableContainer.appendChild(loadingOverlay);
            }
        }

        // Function to hide loading state
        function hideLoadingState() {
            // Remove all loading overlays
            document.querySelectorAll('.loading-overlay').forEach(overlay => {
                overlay.remove();
            });
        }

        // Function to show error message
        function showErrorMessage(message) {
            const errorAlert = document.createElement('div');
            errorAlert.className = 'fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded z-50';
            errorAlert.setAttribute('role', 'alert');
            errorAlert.innerHTML = `
                <strong class="font-bold">Error!</strong>
                <span class="block sm:inline">${message}</span>
                <button class="absolute top-0 bottom-0 right-0 px-4 py-3" onclick="this.parentElement.remove()">
                    <span class="sr-only">Dismiss</span>
                    <i class="fas fa-times"></i>
                </button>
            `;
            document.body.appendChild(errorAlert);
            
            // Remove after 5 seconds
            setTimeout(() => {
                if (errorAlert.parentElement) {
                    errorAlert.remove();
                }
            }, 5000);
        }

        // Function to fetch analytics data from API
        function fetchAnalyticsData(startDate = null, endDate = null) {
            // Show loading indicators
            showLoadingState();
            
            // Build API URL with date parameters if provided
            let apiUrl = '/api/analytics';
            if (startDate && endDate) {
                apiUrl += `?start_date=${startDate}&end_date=${endDate}`;
            }
            
            // Fetch data from API
            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Update dashboard with real data
                    updateDashboardMetrics(data);
                    updateCharts(data);
                    populateRecentInteractions(data.query_analytics ? data.query_analytics.recent_queries : []);
                    
                    // Update last updated timestamp
                    document.getElementById('last-updated').textContent = new Date().toLocaleString();
                    
                    // Hide loading indicators
                    hideLoadingState();
                })
                .catch(error => {
                    console.error('Error fetching analytics data:', error);
                    // Show error message
                    showErrorMessage('Failed to load analytics data. Please try again later.');
                    
                    // Hide loading indicators
                    hideLoadingState();
                });
        }

        // Function to update dashboard metrics with real data
        function updateDashboardMetrics(data) {
            // Update total interactions
            const totalInteractions = data.feedback_summary ? data.feedback_summary.total_feedback : 0;
            document.getElementById('total-interactions').textContent = totalInteractions.toLocaleString();
            
            // Update positive feedback percentage
            const positivePercentage = totalInteractions > 0 && data.feedback_summary
                ? Math.round((data.feedback_summary.positive_feedback / totalInteractions) * 100) 
                : 0;
            document.getElementById('positive-feedback').textContent = positivePercentage + '%';
            
            // Update average response time
            const avgResponseTime = data.response_time_metrics ? data.response_time_metrics.avg_response_time : null;
            document.getElementById('avg-response-time').textContent = avgResponseTime ? avgResponseTime.toFixed(1) + 's' : 'N/A';
            
            // Update token usage
            const totalTokens = data.token_usage_metrics ? data.token_usage_metrics.total_tokens : 0;
            const totalTokensInMillions = totalTokens / 1000000;
            document.getElementById('token-usage').textContent = totalTokens > 0 
                ? totalTokensInMillions.toFixed(1) + 'M' 
                : '0';
        }

        // Function to update all charts with real data
        function updateCharts(data) {
            // Update interactions over time chart
            updateInteractionsChart(data.time_metrics || []);
            
            // Update feedback distribution chart
            updateFeedbackChart(data.feedback_summary || {});
            
            // Update categories chart (using tag distribution as categories)
            updateCategoriesChart(data.tag_distribution || []);
            
            // Update response time chart
            updateResponseTimeChart(data.time_metrics || []);
            
            // Update token usage chart
            updateTokenUsageChart(data.token_usage_metrics ? data.token_usage_metrics.daily_usage || [] : []);
            
            // Update feedback tags chart
            updateFeedbackTagsChart(data.tag_distribution || []);
        }

        // Function to update interactions over time chart
        function updateInteractionsChart(timeMetrics) {
            // Extract dates and counts from time metrics
            const dates = timeMetrics.map(item => formatDate(item.date));
            const counts = timeMetrics.map(item => item.interaction_count);
            
            // Create or update chart
            const interactionsCtx = document.getElementById('interactions-chart').getContext('2d');
            
            // Check if chart already exists and destroy it
            if (window.chartInstances.interactionsChart) {
                window.chartInstances.interactionsChart.destroy();
            }
            
            // Create new chart
            window.chartInstances.interactionsChart = new Chart(interactionsCtx, {
                type: 'line',
                data: {
                    labels: dates.length > 0 ? dates : ['No Data'],
                    datasets: [{
                        label: 'Interactions',
                        data: counts.length > 0 ? counts : [0],
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                drawBorder: false
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Function to update feedback distribution chart
        function updateFeedbackChart(feedbackSummary) {
            // Get positive and negative feedback counts
            const positiveCount = feedbackSummary.positive_feedback || 0;
            const negativeCount = feedbackSummary.negative_feedback || 0;
            
            // Create or update chart
            const feedbackCtx = document.getElementById('feedback-chart').getContext('2d');
            
            // Check if chart already exists and destroy it
            if (window.chartInstances.feedbackChart) {
                window.chartInstances.feedbackChart.destroy();
            }
            
            // Create new chart
            window.chartInstances.feedbackChart = new Chart(feedbackCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Positive', 'Negative'],
                    datasets: [{
                        data: [positiveCount, negativeCount],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ],
                        borderColor: [
                            'rgba(34, 197, 94, 1)',
                            'rgba(239, 68, 68, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    cutout: '70%'
                }
            });
        }

        // Function to update categories chart
        function updateCategoriesChart(tagDistribution) {
            // Sort tags by count and take top 5
            const sortedTags = [...tagDistribution].sort((a, b) => b.count - a.count).slice(0, 5);
            
            // Extract tag names and counts
            const tagNames = sortedTags.map(tag => tag.tag);
            const tagCounts = sortedTags.map(tag => tag.count);
            
            // Create or update chart
            const categoriesCtx = document.getElementById('categories-chart').getContext('2d');
            
            // Check if chart already exists and destroy it
            if (window.chartInstances.categoriesChart) {
                window.chartInstances.categoriesChart.destroy();
            }
            
            // Create new chart
            window.chartInstances.categoriesChart = new Chart(categoriesCtx, {
                type: 'bar',
                data: {
                    labels: tagNames.length > 0 ? tagNames : ['No Data'],
                    datasets: [{
                        label: 'Queries',
                        data: tagCounts.length > 0 ? tagCounts : [0],
                        backgroundColor: [
                            'rgba(79, 70, 229, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(236, 72, 153, 0.8)',
                            'rgba(107, 114, 128, 0.8)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                drawBorder: false
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Function to update response time chart
        function updateResponseTimeChart(timeMetrics) {
            // Extract dates and generate response times
            const dates = timeMetrics.map(item => formatDate(item.date));
            
            // Generate response times from API data or empty array if none
            const responseTimes = timeMetrics.map(item => item.response_time || 0);
            
            // Create or update chart
            const responseTimeCtx = document.getElementById('response-time-chart').getContext('2d');
            
            // Check if chart already exists and destroy it
            if (window.chartInstances.responseTimeChart) {
                window.chartInstances.responseTimeChart.destroy();
            }
            
            // Create new chart
            window.chartInstances.responseTimeChart = new Chart(responseTimeCtx, {
                type: 'line',
                data: {
                    labels: dates.length > 0 ? dates : ['No Data'],
                    datasets: [{
                        label: 'Response Time (s)',
                        data: responseTimes.length > 0 ? responseTimes : [0],
                        backgroundColor: 'rgba(168, 85, 247, 0.1)',
                        borderColor: 'rgba(168, 85, 247, 1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: 'rgba(168, 85, 247, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                drawBorder: false
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Function to update token usage chart
        function updateTokenUsageChart(dailyUsage) {
            // Extract dates and token counts
            const dates = dailyUsage.map(item => formatDate(item.date));
            const tokenCounts = dailyUsage.map(item => item.daily_tokens);
            
            // Create or update chart
            const tokenUsageCtx = document.getElementById('token-usage-chart').getContext('2d');
            
            // Check if chart already exists and destroy it
            if (window.chartInstances.tokenUsageChart) {
                window.chartInstances.tokenUsageChart.destroy();
            }
            
            // Create new chart
            window.chartInstances.tokenUsageChart = new Chart(tokenUsageCtx, {
                type: 'bar',
                data: {
                    labels: dates.length > 0 ? dates : ['No Data'],
                    datasets: [{
                        label: 'Token Usage',
                        data: tokenCounts.length > 0 ? tokenCounts : [0],
                        backgroundColor: 'rgba(234, 179, 8, 0.8)',
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                drawBorder: false
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Function to update feedback tags chart
        function updateFeedbackTagsChart(tagDistribution) {
            // Extract tag names and counts
            const tagNames = tagDistribution.map(tag => tag.tag);
            const tagCounts = tagDistribution.map(tag => tag.count);
            
            // Create or update chart
            const feedbackTagsCtx = document.getElementById('feedback-tags-chart').getContext('2d');
            
            // Check if chart already exists and destroy it
            if (window.chartInstances.feedbackTagsChart) {
                window.chartInstances.feedbackTagsChart.destroy();
            }
            
            // Create new chart
            window.chartInstances.feedbackTagsChart = new Chart(feedbackTagsCtx, {
                type: 'pie',
                data: {
                    labels: tagNames.length > 0 ? tagNames : ['No Data'],
                    datasets: [{
                        data: tagCounts.length > 0 ? tagCounts : [1],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(79, 70, 229, 0.8)',
                            'rgba(168, 85, 247, 0.8)',
                            'rgba(107, 114, 128, 0.8)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        // Helper function to format dates
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Function to populate recent interactions table with real data
        function populateRecentInteractions(interactions) {
            const tableBody = document.getElementById('recent-interactions-table');
            
            // Clear existing rows
            tableBody.innerHTML = '';
            
            // Check if we have interactions
            if (!interactions || interactions.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="7" class="px-6 py-4 text-center text-gray-500">No interactions found</td>
                `;
                tableBody.appendChild(row);
                return;
            }
            
            // Add new rows
            interactions.forEach(interaction => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                // Create badge for feedback
                const feedbackBadge = interaction.feedback_status === 'Positive' 
                    ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Positive</span>'
                    : '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Negative</span>';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${interaction.vote_id || interaction.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" title="${interaction.user_query}">${interaction.user_query.length > 50 ? interaction.user_query.substring(0, 50) + '...' : interaction.user_query}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${feedbackBadge}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${interaction.response_time || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${interaction.tokens || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${interaction.timestamp}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button class="px-3 py-1 border border-gray-300 rounded-md text-xs font-medium text-gray-700 bg-white hover:bg-gray-50">
                            View
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Update pagination info
            const paginationInfo = document.querySelector('.text-sm.text-gray-700');
            if (paginationInfo) {
                paginationInfo.innerHTML = `
                    Showing <span class="font-medium">1</span> to <span class="font-medium">${interactions.length}</span> of <span class="font-medium">${interactions.length}</span> results
                `;
            }
        }

        // Function to initialize date range picker
        function initDateRangePicker() {
            const dateRangeBtn = document.getElementById('date-range-btn');
            const dateRangeText = document.getElementById('date-range-text');
            
            if (!dateRangeBtn) return;
            
            // Store current date range globally
            window.currentStartDate = moment().subtract(6, 'days').format('YYYY-MM-DD');
            window.currentEndDate = moment().format('YYYY-MM-DD');
            
            // Initialize with daterangepicker library
            $(dateRangeBtn).daterangepicker({
                ranges: {
                    'Today': [moment(), moment()],
                    'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                    'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                    'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                    'This Month': [moment().startOf('month'), moment().endOf('month')],
                    'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                },
                startDate: moment().subtract(6, 'days'),
                endDate: moment(),
                opens: 'left',
                alwaysShowCalendars: true
            }, function(start, end, label) {
                // Update the button text with the selected range
                dateRangeText.textContent = label;
                
                // Store current date range for export and filtering
                window.currentStartDate = start.format('YYYY-MM-DD');
                window.currentEndDate = end.format('YYYY-MM-DD');
                
                // Show loading state
                showLoadingState();
                
                // Fetch new data based on the date range
                fetchAnalyticsData(window.currentStartDate, window.currentEndDate);
                
                // Update last updated text
                document.getElementById('last-updated').textContent = moment().format('MMMM D, YYYY h:mm A');
                
                // Log the date range change
                console.log('Date range changed:', window.currentStartDate, 'to', window.currentEndDate);
            });
            
            // Initialize with default range
            dateRangeText.textContent = 'Last 7 Days';
        }

        // Function to set up export button
        function setupExportButton() {
            const exportBtn = document.querySelector('button.ml-4');
            if (exportBtn) {
                exportBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove any existing dropdown
                    const existingDropdown = document.querySelector('.export-dropdown');
                    if (existingDropdown) {
                        existingDropdown.remove();
                    }
                    
                    // Get current date range
                    let exportUrlBase = '/api/analytics/export';
                    
                    // Add date parameters if a specific range is selected
                    if (window.currentStartDate && window.currentEndDate) {
                        exportUrlBase += `?start_date=${window.currentStartDate}&end_date=${window.currentEndDate}`;
                    }
                    
                    // Create dropdown menu for export options
                    const dropdown = document.createElement('div');
                    dropdown.className = 'absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10 export-dropdown';
                    dropdown.innerHTML = `
                        <a href="${exportUrlBase}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                            <i class="fas fa-file-code mr-2"></i>Export as JSON
                        </a>
                        <a href="${exportUrlBase}${exportUrlBase.includes('?') ? '&' : '?'}format=csv" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                            <i class="fas fa-file-csv mr-2"></i>Export as CSV
                        </a>
                        <a href="${exportUrlBase}${exportUrlBase.includes('?') ? '&' : '?'}format=excel" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                            <i class="fas fa-file-excel mr-2"></i>Export as Excel
                        </a>
                    `;
                    
                    // Position the dropdown relative to the button
                    const buttonRect = exportBtn.getBoundingClientRect();
                    dropdown.style.position = 'fixed';
                    dropdown.style.top = (buttonRect.bottom + window.scrollY) + 'px';
                    dropdown.style.right = (window.innerWidth - buttonRect.right) + 'px';
                    
                    // Add to document
                    document.body.appendChild(dropdown);
                    
                    // Close dropdown when clicking outside
                    document.addEventListener('click', function closeDropdown(e) {
                        if (!dropdown.contains(e.target) && e.target !== exportBtn) {
                            dropdown.remove();
                            document.removeEventListener('click', closeDropdown);
                        }
                    });
                    
                    // Prevent event bubbling
                    e.stopPropagation();
                });
            }
        }

        // Function to show export loading state
        function showExportLoadingState() {
            // Create loading overlay
            const loadingOverlay = document.createElement('div');
            loadingOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 export-loading-overlay';
            loadingOverlay.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-4"></div>
                    <p class="text-lg font-semibold">Preparing Export...</p>
                    <p class="text-sm text-gray-500 mt-2">This may take a moment for large datasets.</p>
                </div>
            `;
            
            // Add to document
            document.body.appendChild(loadingOverlay);
            
            // Return the overlay element for later removal
            return loadingOverlay;
        }

        // Function to hide export loading state
        function hideExportLoadingState() {
            // Remove loading overlay
            const loadingOverlay = document.querySelector('.export-loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.remove();
            }
        }

        // Function to setup export links
        function setupExportLinks() {
            document.addEventListener('click', function(e) {
                // Check if the clicked element is an export link
                if (e.target.closest('.export-dropdown a')) {
                    // Show loading state
                    showExportLoadingState();
                    
                    // Hide loading state after 5 seconds (or when download starts)
                    setTimeout(hideExportLoadingState, 5000);
                }
            });
        }

        // Function to setup date range presets
        function setupDateRangePresets() {
            // Create preset buttons container
            const presetsContainer = document.createElement('div');
            presetsContainer.className = 'flex items-center space-x-2 mt-4 date-range-presets';
            presetsContainer.innerHTML = `
                <span class="text-sm text-gray-500">Quick Select:</span>
                <button class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded" data-days="7">Last 7 Days</button>
                <button class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded" data-days="30">Last 30 Days</button>
                <button class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded" data-days="90">Last 90 Days</button>
                <button class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded" data-range="month">This Month</button>
                <button class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded" data-range="year">This Year</button>
            `;
            
            // Add container after the date range button
            const dateRangeBtn = document.getElementById('date-range-btn');
            if (dateRangeBtn && dateRangeBtn.parentNode) {
                dateRangeBtn.parentNode.appendChild(presetsContainer);
            }
            
            // Add event listeners to preset buttons
            presetsContainer.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', function() {
                    let start, end;
                    
                    if (this.dataset.days) {
                        // Last X days
                        const days = parseInt(this.dataset.days);
                        start = moment().subtract(days - 1, 'days');
                        end = moment();
                    } else if (this.dataset.range === 'month') {
                        // This month
                        start = moment().startOf('month');
                        end = moment().endOf('month');
                    } else if (this.dataset.range === 'year') {
                        // This year
                        start = moment().startOf('year');
                        end = moment().endOf('year');
                    }
                    
                    if (start && end) {
                        // Update date range picker
                        $(dateRangeBtn).data('daterangepicker').setStartDate(start);
                        $(dateRangeBtn).data('daterangepicker').setEndDate(end);
                        
                        // Trigger change event
                        $(dateRangeBtn).data('daterangepicker').callback(start, end, this.textContent);
                    }
                });
            });
        }

        // Function to initialize word cloud placeholder
        function initWordCloud() {
            const wordCloudElement = document.getElementById('issues-word-cloud');
            if (wordCloudElement) {
                // This would typically use a word cloud library like d3-cloud
                // For now, we'll just add a placeholder message
                wordCloudElement.innerHTML = '';
            }
        }
    </script>
</body>
</html>
